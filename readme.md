# Postman

## Concept
A Papers, Please inspired game where the player must validate and sort mail, adhereing to increasingly complex rules as time goes on. The story begins with the player going to the post office to forward mail to their new home in this town, when they offer to assist at the post office and become apprenticed .

The player is given the ability to open and re-seal all mail, althought they are expressly forbidden from doing so. Most mail is unreadable, but some story-driven mail is sent that the player can read. The player has the ability to send mail themselves. Initially, the options are meaningless, but reading certain story mail will open up new options. For example, after reading an incriminating letter, the player may choose to give an anonymous tip to the police.

The mail network is fully-simulated. Instead of randomly generating mail for the player to sort through, a list of senders randomly generate mail throughout the mail network every day. This adds many layers to the game. For example, the player may become familiar with the people in their town, may notice pairs of senders frequently replying to each other, etc. Mail the player sends to another town which is improperly addressed will be returned to the player marked "Undeliverable as addressed", for example.

In addition, a visualization of the map and all the mail in transit can be shown at the end of each day.

## Some Player-Facing Mechanics
The player will sort mail, either stamping it as undeliverable and putting it in the sender's box, or putting it in the recipient's box. If the recipient is in another town, the player will reference a map and forward the mail towards the post office of the appropriate town by putting it in the associated mailbox. The player will have to ensure the address is valid, that there is a stamp and that it is sufficient, that the mail is undamaged, and more. Sometimes, undeliverable mail doesn't have a return address. In these cases, the player will file the mail in the recovery bin. Mail in this bin may be subject to retrieval. For instance, a sender may submit a form requesting to recover lost mail at the player's post office. In this case, the player will search their local mail recovery bin for the post. If it isn't found, the player should forward the request to the post office that the mail being searched for would have been forwarded to.

These mechanics all become available to the player as they master previous ones. The pretext is that the postmaster will ask the player to set aside mail they don't know how to handle and will teach the player to handle more situations as the game progresses.

## Mail Simulation
The game world consists of towns. Each with a set of senders, who can generate new mail, and a post office (referred to as a mail router), which can route mail to local recipients or to other post offices. The player controls one of these mail routers.
Each day, every mail router (other than the player) will automatically sort mail according to the complete set of rules listed below and the mail will be delivered to the next step in the mail route. There is a small chance for each mail item handled to be handled improperly. Mail routed to the player will be added to their stack of mail to sort.

## Mail Generation
Mail is generated by senders and routed to their local post office until the amount of mail sent to the player meets two quotas:
The quota for the number of brand new mail that the player must sort, and
the quota for the total amount of mail the player must sort.
The ruleset of the day governs the type of mail randomly generated the morning prior to the player's workday. e.g., damaged mail is not generated the first day.

Step 1: Story mail generation
Pre-scripted mail is occasionally generated and sent to the player on certain days. Story mail will usually have readable content.

Step 2: Existing mail routed
Mail that was routed to the player by other post offices will appear in their queue.

Step 3: Random mail generation
At the beginning of each day, there is a minimum amount of new mail that must arrive for the player. New mail is generated by senders randomly and forwarded to the appropriate mail router (the sender's local post office) until the amount sent to the player's office meets this quota. There is an additional guota for the total amount of mail the player must have to sort for a day. If this quota is not met, mail generation will continue as before until it is.

The when a sender generates mail, they have a high chance of replying to a letter that was sent to them within the week prior.

# Implementation

## Rules
This is a WIP list of rules. Each day uses some set of them. If a rule is not in effect on a given day, mail matching that rule should be set aside.
For example, if the "Damaged mail must be repaired" rule is not in effect, the player should set aside damaged mail, not deliver it.

Mail must go to recipient: Valid mail must be placed in the recipient's box.
Mail must be routed appropriately: Valid mail not addressed to the player's town must be routed to the appropriate neighboring post office.
Mail must be stamped: Mail without a postal stamp must be RTS as "Postage Due"
Stamps must be sufficient: Mail with a stamp not appropriate for routing to another town must be RTS as "Postage shortpaid"
Damaged mail must be repaired: Damaged mail must be taped up.
Mail must be forwarded as requested: If post is addressed to a recipient's old address, a stamp must be placed to clarify the new address and the mail should be routed there.
Unreturnable mail must be placed in recovery: If mail must be returned to sender, but has no return address, it must be dated and placed in the mail recovery bin.

## Mail Routing
For simplicity, the network formed by the postal offices will always be simply-connected. This means that there is only one path between any two postal offices if backtracking is not allowed. This way, when mail must be routed from one office to another, there is always exactly one valid neighbor to route mail to.

## World Generation
The game world consists of towns, which have locations on the map and zip codes. Each town contains 3-8 streets, each of which has 4-12 homes, and each of those may have 1-3 senders. None of these components have actual locations on the map, they are simply used to generate coherent addresses shown on the mail. This is the alternative to randomly generating the addresses for each individual piece of post. Hopefully, this makes the world feel less abstract.

The player's town is generated with a few dozen senders. This number is designed so that the player comes to recognize their names over time. Four towns are generated within a disk around the player's town, and all are connected to the player's town. One of these four is very large (many senders), one is medium, and two are small. After that, six additional towns are randomly generated outside this disk, and each is connected to the nearest town (but never to the player's town). Each of these towns is in the small-to medium size range.

### Town Generation
Each town randomly genrates a random floating-point value for the number of streets via a normal distribution (mu=5.5, s=0.7). Each does the same to determine the number of houses, with a normal distribution of (mu=8, s=1.3) and each house generates the number of senders with (mu=1.8, s=0.6). Because the product of these value's means approximately govern the town's mean population, the *cube root* of the town size multiplier is multiplied by every random value. These values are then rounded to the nearest integer or up to the minimum value. The minimum number of streets is 2, the minimum number of houses is 2, and the minimum number of senders is 1. Some (~5% of) houses randomly skip sender generation, creating empty houses.

## Settings

### World Generation
**Town Size Multiplier**: The average number of residents in each town is multiplied by this number. At a multiplier of 1, the average town will have 80 residents. (Default: 1)

**Number of Connecting Towns**: The number of towns that generate that are directly connected to the player's town. (Default: 4)

**Number of Additional Towns**: The number of towns that generate which don't connect directly to the player's town. (Default: 6)

### Difficulty

**Mail Multiplier**: The mail quota, new mail quota, and max mail are multiplied by this value.

## Hidden Settings

### World Generation
**min_town_sep**: The minimum allowable distance between two towns during generation.

### Difficulty
**max_mail_mul**: The max mail is multiplied by this value. Can be increased to gauruntee the player handle's all mail without increasing the quota.

## Day Specification

All days are enumerated in "days.json". All probabilites are given as decimals (i.e. 0.12 = 12%)

**prob_sender_shortpays**: Probability that the mail will have invalid indicia (insufficient/missing stamp). If the due postage is low (sender and recipient are in the same town), this will cause the stamp to be missing. If the postage due is high, there is an equal chance the stamp will be missing or insufficient.

**prob_sender_damages_mail**: Probability that mail will be damaged upon generation.

**prob_router_damages_mail**: Probability that a simulated post office will damage mail. The next post office on the route will have to repair it.

**prob_sender_moves**: Probability that a sender will move to an empty home and make a request to forward mail.

**new_mail_quota**: The amount of brand-new mail the player must handle this day.

**mail_quota**: The amount of mail the player must handle on this day.

**mail_limit**: The maximum amount of mail the player can handle this day.

## Post Office AI
The AI does not actually exist on a post office class or the town class. Actually, the AI is encapsulated in the mail.handle() function, which changes variables within the mail class to allow it to transit.

The mail class maintains three relevant variables; these are the previous, current, and following variables. Each holds a town or a house and allows you to check where the mail was, where it is, and where it is going. When mail is created, previous is set to the sender, current is set to the sender's town, and following is set to None. The purpose of the handle() function is to set value of mail.following. Note that artificial error is introduced at this stage. mail.following is set to where the mail *will* go, not necessarily where it *should* go.

The mail.advance() function moves the mail by updating the variables appropriately.

## Main Loop

The game operates on a central loop of actions outlined below.

1 Day begins

2 If there are any morning sequences due, play them.

3 Prepare the mail queue for each player. This is done by moving mail from the PO's queue to the player's queue as needed. Ideally, all mail for the PO would be handled by the player, but some may be handled automatically to limit the player's workload.

	1 Any mail in the PO's queue marked as story mail is moved to the player's queue
	
	2 Shuffle the PO's queue
	
	2 Move new mail (with age=0) from the PO's queue into the player's queue. Stop when the new mail quota is met, the PO's queue is emptied, or the max mail limit is reached.
	
	3 Move all kinds of mail from the PO's queue into the player's queue. Stop when the mail quota is met, the PO's queue is emptied, or the max mail limit is reached.
	
	4 Generate new mail until the new mail quota and the general mail quota are met.

Note that in actuality, the POs *don't* track the mail in their queue. The function to handle a mail-item is actually a member of the mail class itself as this removes the overhead of having mail items remove themselves from a queue and re-add themselves to a new one each time they change locations. Because of this, the above steps are actually performed by looping over all the mail and moving them to the appropriate player's queue if they pass an enormous conditional statement, which is broken into several conditionals for readability.